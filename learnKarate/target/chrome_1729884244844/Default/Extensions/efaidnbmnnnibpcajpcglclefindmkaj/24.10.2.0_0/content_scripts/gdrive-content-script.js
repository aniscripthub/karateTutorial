/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
(()=>{const e="-shared",t="acrobatDisconnectContentScriptStart",o="acrobatContentScriptDisconnectEnd",n="acrobat-prompt",i="acrobat-fte-tooltip-container",r="acrobat-gdrive-fte-state";let a,c,s,d,l=!1,m=new AbortController,u={addedAdobeCleanFont:!1,fteToolTip:{}};const p=()=>!chrome.runtime?.id,w=()=>window.location.pathname.includes("/file"),h=e=>{try{chrome.runtime.sendMessage({main_op:"analytics",analytics:e})}catch(e){}},g=(new Set,t=>{if(l||t){const t=document.getElementsByClassName(n);if(t?.length>0){const e=t[0].getElementsByClassName(i);e?.length>0&&h(["DCBrowserExt:GdriveFTE:NativeView:Dismissed"]),t[0].remove()}const o=document.getElementsByClassName(n+e);o?.length>0&&o[0].remove();const r=document.getElementById("acrobat-prompt");r?.remove(),l=!1}}),b=(e,t)=>{if(e){const o=a?.selectors,n=o&&o[t];for(let t=0;t<n?.length;t++){let o=e.querySelector(n[t]);if(o)return o}}return null},v=()=>b(document,"fileDetails"),f=e=>{try{return JSON.parse(e?.textContent?.replace(/\\/g,""))}catch(e){return null}};let E="0";const C=()=>{const t=document.createElement("div"),o=(()=>{const e=document.createElement("img");e.setAttribute("src",chrome.runtime.getURL("browser/images/acrobat_dc_appicon_128.png"));const t=w()?"acrobat-icon-shared":"acrobat-icon";return e.setAttribute("class",t),e})(),i=(()=>{const e=document.createElement("span"),t=w()?"acrobat-prompt-text-shared":"acrobat-prompt-text";return e.setAttribute("class",t),e.textContent=a?.acrobatPromptText||"Edit with Acrobat",e})(),c=(()=>{const e=document.createElement("div"),t=w()?"acrobat-prompt-tooltip":"acrobat-prompt-tooltip-shared";return e.setAttribute("class",t),e.textContent=a?.acrobatPromptText||"Open in Acrobat",e})(),s=w()?n+e:n;return t.setAttribute("class",s),t.appendChild(o),t.appendChild(c),t.appendChild(i),t.addEventListener("click",(()=>(()=>{if(p())return void g();const{acrobatTouchPointClicked:e,getAcrobatTouchPointFteEligibility:t}=d;e(r),u.fteToolTip.touchPointClicked=!0;const o=v(),n=f(o);h([["DCBrowserExt:Gdrive:OpenInExtension:Clicked",{gsuiteFte:t(a?.enableFteToolTip)}]]);const i=chrome.runtime.getURL("viewer.html")+"?pdfurl="+encodeURIComponent(`https://drive.usercontent.google.com/download?id=${n.id}&authuser=${E}&acrobatPromotionSource=GoogleDriveNativeView`)+"&pdffilename="+encodeURIComponent(n.title);window.open(i,"_blank")})()),{signal:m.signal}),t},T=e=>{const t=document.getElementsByClassName(i);"Enter"!==e.key&&"ArrowLeft"!==e.key&&"ArrowRight"!==e.key&&"click"!==e.type||t?.length>0&&(t[0]?.contains(e.target)||(t[0].remove(),h(["DCBrowserExt:GdriveFTE:NativeView:Dismissed"]),document.removeEventListener("click",T),document.removeEventListener("keydown",T)))},y=e=>{const{createFteTooltip:t}=d,o=t(a?.fteToolTipStrings,"gdriveNativeView");(e=>{e.querySelector(".acrobat-fte-tooltip-button").addEventListener("click",(()=>{e.remove(),h(["DCBrowserExt:GdriveFTE:NativeView:Clicked"]),document.removeEventListener("click",T),document.removeEventListener("keydown",T)}))})(o),document.addEventListener("click",T,{signal:m.signal}),document.addEventListener("keydown",T,{signal:m.signal}),e.appendChild(o),h(["DCBrowserExt:GdriveFTE:NativeView:Shown"]);const{updateFteToolTipCoolDown:n}=d;n(a?.fteConfig?.tooltip,r).then((e=>{u.fteToolTip={...u?.fteToolTip,...e}}))},L=()=>{try{if(l)return;const e=C(),t=(()=>{let e;for(let t=0;t<a?.selectors?.promptParentElement.length&&(e=document.querySelector(a?.selectors?.promptParentElement[t]),!e);t++);return e})();if(t){if(t.prepend(e),l=!0,window.innerWidth>1080){h([["DCBrowserExt:Gdrive:OpenInExtension:Shown",{gsuiteFte:d?.getAcrobatTouchPointFteEligibility(a?.enableFteToolTip)}]]);const{shouldShowFteTooltip:t}=d,o=a?.fteConfig?.tooltip;t(o,u?.fteToolTip,a?.enableFteToolTip).then((t=>{t&&setTimeout((()=>{y(e)}),1e3)}))}}else g()}catch(e){g()}},x=()=>{const e=v();if(e){"application/pdf"===f(e).mimeType?L():g()}else g()},D=()=>{g(!0)},F=()=>{p()&&(s&&s.disconnect(),g(),m.abort(),window.dispatchEvent(new CustomEvent(o,{detail:{state:u}})))},S=()=>{window.addEventListener(o,(e=>(e=>{p()||(u=e.detail.state)})(e)),{signal:u?.eventControllerSignal}),window.dispatchEvent(new Event("orphanContentScript")),window.dispatchEvent(new Event(t)),window.addEventListener(t,F,{signal:m.signal}),chrome.runtime.sendMessage({main_op:"gdrive-init"},(e=>{(e.enableOpenInExtension||window.location?.search?.includes("enableAcrobatPromptInGSuite"))&&(h([["DCBrowserExt:Gdrive:OpenInExtension:Enable"]]),e?.enableFteToolTip&&h([["DCBrowserExt:GdriveFTE:Enable"]]),a=e,(()=>{if(window?.document?.location?.pathname.includes("/u/"))return void(E=window.document.location.pathname.split("/")[3]);const e=document.createElement("script");document.addEventListener("acrobat-auth-user-id",(t=>{E=t?.detail?.authuser,e.remove()})),e.type="text/javascript",e.src=chrome.runtime.getURL("content_scripts/gdrive/get-auth-user.js"),document.head.appendChild(e)})(),c=chrome.runtime.getURL("browser/images/acrobat_dc_appicon_128.png"),(()=>{const e=chrome.runtime.getURL("content_scripts/gsuite/fte-utils.js");return new Promise((t=>{import(e).then((e=>{d=e,t()}))}))})().then((()=>{(async()=>{const e=(new Date).getTime();let t={count:0,nextDate:e};t=(await chrome.storage.local.get(r))?.[r]||t;const o=a?.fteConfig?.tooltip;((e,t)=>-1!==e?.resetDay&&t>e?.resetDay)(o,e)&&(t.count=0,t.nextDate=e),u.fteToolTip={...t},t={[r]:t},chrome.storage.local.set(t)})(),(()=>{if(!u?.adobeCleanFontAdded){const e=chrome.runtime.getURL("browser/css/fonts/AdobeClean-Regular.otf"),t=new FontFace("AdobeClean-Regular",`url(${e})`);t.load().then((()=>{document.fonts.add(t)})),u.adobeCleanFontAdded=!0}})(),D(),x(),(()=>{try{const e={childList:!0,subtree:!0,attributes:!0,attributeFilter:["style"]};s=new MutationObserver((function(){s.takeRecords(),p()?(s.disconnect(),g()):x()})),s.observe(document.body,e)}catch(e){}})()})))}))},R=()=>{const e=new URLSearchParams(window.location.search);e?.has("acrobatPromotionSource")&&(e?.has("uuid")&&"https://accounts.google.com/"!==document.referrer||chrome.runtime.sendMessage({main_op:"gdrive-download-init"},(e=>{a=e;let{nameElement:t,pdfURLObject:o}=(()=>{const e=b(document,"confirmInput")?.value,t=b(document,"atInput")?.value,o=b(document,"uuidInput")?.value,n=b(document,"fileName");let i=new URL(window.location.href);return i.searchParams.set("uuid",o),i.searchParams.set("at",t),i.searchParams.set("confirm",e),{nameElement:n,pdfURLObject:i}})(),n=chrome.runtime.getURL("viewer.html")+"?pdfurl="+encodeURIComponent(o.toString());t?.textContent&&(n=n+"&pdffilename="+encodeURIComponent(t?.textContent)),h([["DCBrowserExt:GdriveDPage:Redirect"]]),window.location.replace(n)})))};chrome.runtime.onMessage.addListener((function(e){"acrobatGsuiteTouchPointsDisabled"===e.content_op&&(s?.disconnect(),D())})),chrome.runtime.onMessage.addListener((function(e){"acrobatGdriveFteStateUpdated"===e.content_op&&(u.fteToolTip={...u?.fteToolTip,...e?.fteState})})),chrome.storage.local.get("acrobat-gsuite-touch-points",(e=>{"false"!==e["acrobat-gsuite-touch-points"]&&("drive.google.com"===window?.document?.location?.host&&window.top===window.self&&0===window?.document?.location?.ancestorOrigins.length?S():"drive.usercontent.google.com"===window?.document?.location?.host&&window.top===window.self&&0===window?.document?.location?.ancestorOrigins.length&&R())}))})();